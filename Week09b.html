<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Resistant lines</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #0000ff; } /* Keyword */
code > span.ch { color: #008080; } /* Char */
code > span.st { color: #008080; } /* String */
code > span.co { color: #008000; } /* Comment */
code > span.ot { color: #ff4000; } /* Other */
code > span.al { color: #ff0000; } /* Alert */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #008000; font-weight: bold; } /* Warning */
code > span.cn { } /* Constant */
code > span.sc { color: #008080; } /* SpecialChar */
code > span.vs { color: #008080; } /* VerbatimString */
code > span.ss { color: #008080; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { } /* Variable */
code > span.cf { color: #0000ff; } /* ControlFlow */
code > span.op { } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #ff4000; } /* Preprocessor */
code > span.do { color: #008000; } /* Documentation */
code > span.an { color: #008000; } /* Annotation */
code > span.cv { color: #008000; } /* CommentVar */
code > span.at { } /* Attribute */
code > span.in { color: #008000; } /* Information */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' || rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="libs\style.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<div class="container-fluid main-container">

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->



<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
    
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Data Manipulation
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Week 02</li>
    <li>
      <a href="Week02a.html">Data types</a>
    </li>
    <li>
      <a href="Week02b.html">Reading and writing data files</a>
    </li>
    <li>
      <a href="Week02c.html">Working with date objects</a>
    </li>
    <li>
      <a href="Week02d.html">Exploring and cleaning dataframes using base functions</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Week 03</li>
    <li>
      <a href="Week03a.html">Manipulating dataframes with dplyr</a>
    </li>
    <li>
      <a href="Week03d.html">Working with string objects</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Week 04</li>
    <li>
      <a href="Week03ab_groupby.html">Grouping and summarizing tables</a>
    </li>
    <li>
      <a href="Week03b.html">Tidying/reshaping tables using tidyr</a>
    </li>
    <li>
      <a href="Week03c.html">Joining data tables</a>
    </li>
    <li>
      <a href="Week03ab_examples.html">Example of data manipulation workflows</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Plots
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Week 05</li>
    <li>
      <a href="Week04a.html">The base plotting environment</a>
    </li>
    <li>
      <a href="Week04b.html">The lattice plotting environment</a>
    </li>
    <li>
      <a href="Week04c.html">The ggplot plotting environment</a>
    </li>
    <li>
      <a href="Week04d.html">Manipulating colors in R</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Univariate
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Week 06</li>
    <li>
      <a href="Week05a.html">Visualizing univariate data</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Week 07</li>
    <li>
      <a href="Week05b.html">Comparing univariate data distributions</a>
    </li>
    <li>
      <a href="Week06a.html">Theoretical Q-Q plot</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Week 08</li>
    <li>
      <a href="Week07a.html">Fits and residuals</a>
    </li>
    <li>
      <a href="Week07b.html">Spread-location plot</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Week 09</li>
    <li>
      <a href="Week08a.html">Re-expressing data</a>
    </li>
    <li>
      <a href="Week08b.html">Letter value summaries</a>
    </li>
    <li>
      <a href="Week08c.html">The Two R’s of EDA</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Bivariate
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Week 10</li>
    <li>
      <a href="Week09a.html">Bivariate analysis</a>
    </li>
    <li>
      <a href="Week09b.html">Resistant lines</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Week 11</li>
    <li>
      <a href="Week10a.html">The third R of EDA: Residuals</a>
    </li>
    <li>
      <a href="Week10b.html">Detecting discontinuities in the data</a>
    </li>
    <li>
      <a href="http://mgimond.github.io/Stats-in-R/regression.html">Details of the OLS regression method (optional reading)</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Two-way tables
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Week 12</li>
    <li>
      <a href="Week11a.html">Median polish/Mean polish</a>
    </li>
    <li>
      <a href="http://mgimond.github.io/Stats-in-R/ANOVA.html">Details of an ANOVA (optional reading)</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Misc
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="Misc01.html">R markdown documents</a>
    </li>
    <li class="dropdown-header">Week 13</li>
    <li>
      <a href="Week12a.html">Creating maps in R</a>
    </li>
    <li class="dropdown-header">Connecting to relational databases</li>
  </ul>
</li>
<li>
  <a href="Data.html">Datasets</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->
<link href="https://fonts.googleapis.com/css?family=Open+Sans%7CSource+Code+Pro" rel="stylesheet">

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Resistant lines</h1>

</div>


<div style="color:#ff7535; background-color:#fff0ee ;   border-left-style: solid">
<p>This tutorial makes use of the following R package(s): <strong><code>dplyr</code></strong>, <strong><code>lubridate</code></strong> and <strong><code>ggplot2</code></strong>.</p>
<p>This material is intended to supplement <strong>pages 110 to 119</strong> of <strong>Cleveland’s book</strong>.</p>
</div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>Ordinary least squares regression lines (those created with the <code>lm()</code> function) suffer from sensitivity to outliers. Because <code>lm</code>’s best fit line makes use of the mean (which is not a robust measure of location), its breakdown point is <span class="math inline">\(1/n\)</span> meaning that all it takes is for one data point to behave differently from the rest of the points to significantly alter the slope and intercept of the best fit line. For example, let’s start with a well behaved dataset where all points are perfectly aligned and fit this batch with a regression line:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">11</span>)
y &lt;-<span class="st"> </span><span class="dv">5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>x
<span class="kw">plot</span>(y <span class="op">~</span><span class="st"> </span>x, <span class="dt">pch=</span><span class="dv">20</span>)
M &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>x)
<span class="kw">abline</span>( M , <span class="dt">col=</span><span class="st">&quot;red&quot;</span>)</code></pre></div>
<p><img src="Week09b_files/figure-html/unnamed-chunk-2-1.png" width="288" /></p>
<p>As expected, we have a perfect fit. And the regression model’s coefficients match those used to create the data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">coef</span>(M)</code></pre></div>
<pre><code>(Intercept)           x 
          5           2 </code></pre>
<p>Now, what if one of the points is re-positioned in the plot, what happens to the regression line?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">y[<span class="dv">11</span>] &lt;-<span class="st"> </span><span class="dv">2</span>
<span class="kw">plot</span>(y <span class="op">~</span><span class="st"> </span>x, <span class="dt">pch=</span><span class="dv">20</span>)
M &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>x)
<span class="kw">abline</span>( M , <span class="dt">col=</span><span class="st">&quot;red&quot;</span>)</code></pre></div>
<p><img src="Week09b_files/figure-html/unnamed-chunk-4-1.png" width="288" /></p>
<p>Note the significant change in the line’s characteristics, its intercept and slope are now:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">coef</span>(M)</code></pre></div>
<pre><code>(Intercept)           x 
  9.5454545   0.8636364 </code></pre>
<p>The slope dropped from 2 to 0.86 because of a single point!</p>
<p>If our goal is to explore what the bulk of the data has to say about the phenomena being investigated, we certainly don’t want a small batch of “maverick” values to hijack the analysis. We therefore need a set of fitting tools that minimize the influence of outliers. There are many options out there; most notable are Tukey’s <strong>3-point summary line</strong> and the <strong>bisquare</strong> robust estimation method outlined in Cleveland’s text.</p>
</div>
<div id="robust-lines" class="section level1">
<h1>Robust lines</h1>
<div id="tukeys-3-point-summary" class="section level2">
<h2>Tukey’s 3-point summary</h2>
<p>The idea is simple in concept and easy to implement with a pen and paper if the dataset is not too big. It involves dividing the dataset into three approximately equal groups of values and summarizing these groups by computing their respective medians. Two half-slopes are then used to join the three points. Note that points that share the same x value are lumped into the same batch which can lead to unequal group sizes. The motivation behind this plot is to use the three-point summary to provide a robust assessment of the type of relationship between both variables. Such plots are often used to help guide re-expression of the variables x or y or both for the sole purpose of straightening the x-y relationship.</p>
<p>Let’s look at an example using the last (modified) dataset. First, we’ll divide the plot into three approximately equal batches.</p>
<p><img src="Week09b_files/figure-html/unnamed-chunk-7-1.png" width="288" /></p>
<p>Next, compute the median x and y values within each section.</p>
<p><img src="Week09b_files/figure-html/unnamed-chunk-8-1.png" width="288" /></p>
<p>Note that we do not include the same point in any two median calculations. This implies that for the mid-third of the data, we do not include the point straddling the left boundary line when computing its median value. Likewise with the right-third of the data.</p>
<p>The x median values are 2.5, 6, 9.5 and the y median values are 10, 17, 22.</p>
<p>Finally, we fit the tail end medians with a straight line.</p>
<p><img src="Week09b_files/figure-html/unnamed-chunk-9-1.png" width="288" /></p>
<p>This gives us the slope of the line (we can, of course, extend the lines to the boundaries of the x range of values). Note that we have not completely eliminated the influence of the outlier. The outlier does take part in helping fit the line, but it doesn’t wield the same disproportionate influence on the line as did the regression line.</p>
<p>So what purpose does the middle median serve? It helps us adjust the vertical location of the line. The goal is to nudge the line upward or downward about 1/3 of the way towards the middle median value (parallel to the y-axis). This then defines the line’s <em>intercept</em> (which is where the line crosses the y-axis when x = 0).</p>
<p><img src="Week09b_files/figure-html/unnamed-chunk-10-1.png" width="288" /></p>
<p>But you need not stop here. The next logical step is to look at the residuals. The following two plots compare the residuals from the regression model and the 3-point summary plot.</p>
<p><img src="Week09b_files/figure-html/unnamed-chunk-11-1.png" width="576" /></p>
<p>Recall that we are seeking to minimize any non-random pattern in the residual. Even though a monotonic increase in residuals is discernible in both plots, the 3-point summary residual has less of a slope and (ignoring the outlier) has a smaller spread.</p>
<p>The 3-point summary fitting process can be extended by adding the residual slope to the original slope. This process is iterated as many times as needed until the residual slope is close to zero.</p>
</div>
<div id="bisquare" class="section level2">
<h2>Bisquare</h2>
<p>In his book (pages 112 - 119), Cleveland uses the <em>bisquare</em> estimation method to come up with a robust line. The first step is to run a linear regression model on the data then to extract the residuals. Next, a weighting scheme is fit to the residuals such that the points associated with outlier residuals are assigned the smallest weight and the points associated with the central residual values are assigned the largest weight. The regression analysis is then re-run using those same weights thus minimizing the influence of the rogue points. This process is repeated several times until the residuals no longer show outliers.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Create the bisquare function</span>
wt.bisquare &lt;-<span class="st"> </span><span class="cf">function</span>(u, <span class="dt">c=</span><span class="dv">6</span>) {
   <span class="kw">ifelse</span>( <span class="kw">abs</span>(u<span class="op">/</span>c) <span class="op">&lt;</span><span class="st"> </span><span class="dv">1</span>, (<span class="dv">1</span><span class="op">-</span>(u<span class="op">/</span>c)<span class="op">^</span><span class="dv">2</span>)<span class="op">^</span><span class="dv">2</span>, <span class="dv">0</span>)
}

<span class="co"># Assign an equal weight to all points</span>
wt &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span>,<span class="kw">length</span>(x))

<span class="co"># Compute the regression, then assign weights based on residual values</span>
<span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>){
  dat.lm &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>x ,<span class="dt">weights=</span>wt)
  wt &lt;-<span class="st"> </span><span class="kw">wt.bisquare</span>( dat.lm<span class="op">$</span>res<span class="op">/</span><span class="st"> </span><span class="kw">median</span>(<span class="kw">abs</span>(dat.lm<span class="op">$</span>res)), <span class="dt">c=</span><span class="dv">6</span> )
}

<span class="co"># Plot the data and the resulting line</span>
<span class="kw">plot</span>(x,y, <span class="dt">pch=</span><span class="dv">20</span>)
<span class="kw">abline</span>(dat.lm, <span class="dt">col=</span><span class="kw">rgb</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">0.3</span>))</code></pre></div>
<p><img src="Week09b_files/figure-html/unnamed-chunk-12-1.png" width="576" /></p>
<p>In the above example, the bisquare method does a great job in eliminating the outlier’s influence.</p>
<div id="sample-data" class="section level3">
<h3>Sample data</h3>
<p>In this example, we fit both an un-modified regression line (dashed grey line) and a bisquare modified regression line (red line) to yearly mean temperature values for the Gulf of Maine.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(lubridate)
<span class="kw">library</span>(dplyr)
df &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;http://mgimond.github.io/ES218/Data/GoM_hist.csv&quot;</span>)

<span class="co"># Subset the data then compute the yearly mean temperature</span>
df2 &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span>
<span class="st">       </span><span class="kw">mutate</span>(<span class="dt">Date =</span> <span class="kw">mdy</span>(Date),
              <span class="dt">Year =</span> <span class="kw">year</span>(Date)) <span class="op">%&gt;%</span>
<span class="st">       </span><span class="kw">filter</span>(Year <span class="op">&gt;</span><span class="st"> </span><span class="dv">1950</span>) <span class="op">%&gt;%</span>
<span class="st">       </span><span class="kw">group_by</span>( Year) <span class="op">%&gt;%</span>
<span class="st">       </span><span class="kw">summarize</span>( <span class="dt">AvgTemp =</span> <span class="kw">mean</span>(Temp, <span class="dt">na.rm=</span>T)) 

<span class="co"># Generate the base regression model</span>
M1 &lt;-<span class="st"> </span><span class="kw">lm</span>( AvgTemp <span class="op">~</span><span class="st"> </span>Year, <span class="dt">dat=</span>df2)

<span class="co"># Run the bisquare regression model </span>
<span class="co"># We&#39;ll use the wt.bisquare() function from the last chunk of code</span>
wt &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span>,<span class="kw">length</span>(df2<span class="op">$</span>Year))

<span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>){
  M2 &lt;-<span class="st"> </span><span class="kw">lm</span>(AvgTemp <span class="op">~</span><span class="st"> </span>Year,df2 ,<span class="dt">weights=</span>wt)
  wt &lt;-<span class="st"> </span><span class="kw">wt.bisquare</span>( M2<span class="op">$</span>res<span class="op">/</span><span class="st"> </span><span class="kw">median</span>(<span class="kw">abs</span>(M2<span class="op">$</span>res)), <span class="dt">c=</span><span class="dv">6</span> )
}

<span class="co"># Plot the points</span>
<span class="kw">plot</span>(AvgTemp <span class="op">~</span><span class="st"> </span>Year,df2, <span class="dt">pch=</span><span class="dv">16</span>, <span class="dt">col=</span><span class="kw">rgb</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">0.2</span>))

<span class="co"># Add the robust line</span>
<span class="kw">abline</span>( M2, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>)

<span class="co"># Add the default regression line</span>
<span class="kw">abline</span>( M1 , <span class="dt">col=</span><span class="st">&quot;grey50&quot;</span>, <span class="dt">lty=</span><span class="dv">2</span>)</code></pre></div>
<p><img src="Week09b_files/figure-html/unnamed-chunk-13-1.png" width="576" /></p>
<p>Note the difference in slopes: The robust regression method computes a slope of 0.0298 while the original regression model computes a slope of 0.0197.</p>
</div>
<div id="built-in-implementation-of-the-bisquare" class="section level3">
<h3>Built-in implementation of the bisquare</h3>
<p>The <code>MASS</code> package has a robust linear modeling function called <code>rlm</code> that will implement a variation of the aforementioned bisquare estimation technique. Its results may differ slightly from those presented here, but the difference will be insignificant for the most part.</p>
<p>Note that if you make use of <code>dplyr</code> in a work flow, loading <code>MASS</code> after <code>dplyr</code> will mask dplyr’s <code>select</code> function. This can be problematic. So you either want to load <code>MASS</code> before <code>dplyr</code>, or you can call the function via <code>MASS::rlm</code>. An example of its use follows.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">M2.r &lt;-<span class="st"> </span>MASS<span class="op">::</span><span class="kw">rlm</span>( AvgTemp <span class="op">~</span><span class="st"> </span>Year, <span class="dt">dat=</span>df2, <span class="dt">psi=</span><span class="st">&quot;psi.bisquare&quot;</span>)
<span class="kw">plot</span>(AvgTemp <span class="op">~</span><span class="st"> </span>Year,df2, <span class="dt">pch=</span><span class="dv">16</span>, <span class="dt">col=</span><span class="kw">rgb</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">0.2</span>))
<span class="co"># Add the robust line</span>
<span class="kw">abline</span>( M2.r, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>)
<span class="co"># Add the default regression line</span>
<span class="kw">abline</span>( M1 , <span class="dt">col=</span><span class="st">&quot;grey50&quot;</span>, <span class="dt">lty=</span><span class="dv">2</span>)</code></pre></div>
<p><img src="Week09b_files/figure-html/unnamed-chunk-14-1.png" width="576" /></p>
<p>The function <code>rlm</code> can also be called directly from within <code>ggplot</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)
<span class="kw">ggplot</span>(df2, <span class="kw">aes</span>(<span class="dt">x=</span>Year, <span class="dt">y=</span>AvgTemp)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span>
<span class="st">        </span><span class="kw">geom_smooth</span>(<span class="dt">method=</span><span class="st">&quot;lm&quot;</span>, <span class="dt">se=</span><span class="ot">FALSE</span>, <span class="dt">col=</span><span class="st">&quot;grey50&quot;</span>, <span class="dt">lty=</span><span class="dv">2</span>) <span class="op">+</span>
<span class="st">       </span><span class="kw">geom_smooth</span>(<span class="dt">method=</span>MASS<span class="op">::</span>rlm, <span class="dt">se=</span><span class="ot">FALSE</span>, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>,
                   <span class="dt">method.args=</span><span class="kw">list</span>(<span class="dt">psi=</span><span class="st">&quot;psi.bisquare&quot;</span>))</code></pre></div>
<p><img src="Week09b_files/figure-html/unnamed-chunk-15-1.png" width="576" /></p>
</div>
</div>
</div>
<div id="robust-loess" class="section level1">
<h1>Robust loess</h1>
<p>The bisquare estimation method can also be extended to the loess smoothing function. The following chunk of code fits both an uncorrected robust loess (dashed curve) and a bisquare loess (red curve) to the Gulf of Maine temperature data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Fit a regular loess model</span>
lo &lt;-<span class="st"> </span><span class="kw">loess</span>(AvgTemp <span class="op">~</span><span class="st"> </span>Year,df2, <span class="dt">span=</span><span class="dv">1</span><span class="op">/</span><span class="dv">3</span>)

<span class="co"># Fit a robust loess model</span>
wt &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span>,<span class="kw">length</span>(df2<span class="op">$</span>Year))

<span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>){
  lo2 &lt;-<span class="st"> </span><span class="kw">loess</span>(AvgTemp <span class="op">~</span><span class="st"> </span>Year,df2, <span class="dt">weights =</span> wt, <span class="dt">span=</span><span class="dv">1</span><span class="op">/</span><span class="dv">3</span>)
   wt &lt;-<span class="st"> </span><span class="kw">wt.bisquare</span>( lo2<span class="op">$</span>res<span class="op">/</span><span class="st"> </span><span class="kw">median</span>(<span class="kw">abs</span>(lo2<span class="op">$</span>res)), <span class="dt">c=</span><span class="dv">6</span> )
}

<span class="co"># Plot the data</span>
<span class="kw">plot</span>(AvgTemp <span class="op">~</span><span class="st"> </span>Year,df2, <span class="dt">pch=</span><span class="dv">16</span>, <span class="dt">col=</span><span class="kw">rgb</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">0.2</span>))

<span class="co"># Add the robust loess</span>
<span class="kw">lines</span>(df2<span class="op">$</span>Year, <span class="kw">predict</span>(lo2), <span class="dt">col=</span><span class="st">&quot;red&quot;</span>)

<span class="co"># Add the default loess</span>
<span class="kw">lines</span>(df2<span class="op">$</span>Year, <span class="kw">predict</span>(lo), <span class="dt">col=</span><span class="st">&quot;grey50&quot;</span>, <span class="dt">lty=</span><span class="dv">2</span>)</code></pre></div>
<p><img src="Week09b_files/figure-html/unnamed-chunk-16-1.png" width="576" /></p>
<p>The two curves overlap for most of the data range except between the years 2000 and 2010 where the un-corrected loess curve is unduly influenced by one or two rogue points incorrectly suggesting that a <em>hump</em> in water temperature occurred between the years 2000 and 2010.</p>
<p>The R base <code>loess</code> function and <code>ggplot2</code>’s <code>stat_smooth</code> function have the ability to compute a robust version of the loess by invoking the <code>family = &quot;symmetric&quot;</code> parameter as in,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)
<span class="kw">ggplot</span>(df2) <span class="op">+</span><span class="st"> </span><span class="kw">aes</span>(<span class="dt">x=</span>Year, <span class="dt">y=</span>AvgTemp) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span>
<span class="st">              </span><span class="kw">stat_smooth</span>(<span class="dt">method.args =</span> <span class="kw">list</span>(<span class="dt">family=</span><span class="st">&quot;symmetric&quot;</span>),    <span class="co"># Robust loess</span>
                          <span class="dt">se=</span><span class="ot">FALSE</span>, <span class="dt">span=</span><span class="dv">1</span><span class="op">/</span><span class="dv">3</span>, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>) <span class="op">+</span><span class="st">  </span>
<span class="st">              </span><span class="kw">stat_smooth</span>( <span class="dt">se=</span><span class="ot">FALSE</span>, <span class="dt">span=</span><span class="dv">1</span><span class="op">/</span><span class="dv">3</span>,<span class="dt">col=</span><span class="st">&quot;grey50&quot;</span>, <span class="dt">lty=</span><span class="dv">2</span>)   <span class="co"># Regular loess           </span></code></pre></div>
<p><img src="Week09b_files/figure-html/unnamed-chunk-17-1.png" width="576" /></p>
<p>The red curve is that of the robust loess and the grey dashed curve is that of the standard loess.</p>
</div>


<div class="footer">
<hr/>
<a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/80x15.png" /></a>  Manny Gimond (2018)
</br>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
